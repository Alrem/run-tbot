# Continuous Deployment Workflow
# Automatically deploys to Google Cloud Run after successful CI on main branch
# Builds Docker image, pushes to GitHub Container Registry, deploys to Cloud Run

name: Deploy to Cloud Run

# Trigger: only after successful CI workflow completion on main branch
# This ensures deployment happens only when all tests and checks pass
# workflow_run waits for the "CI" workflow to complete
# The if condition below ensures we only deploy on success (not failure)
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

# Environment variables used across all jobs
env:
  REGISTRY: ghcr.io                                   # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }}                # e.g., yourusername/run-tbot
  SERVICE_NAME: run-tbot                              # Cloud Run service name
  REGION: ${{ secrets.GCP_REGION }}                   # Cloud Run region (e.g., us-central1)

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    # Only run if CI workflow succeeded
    # github.event.workflow_run.conclusion contains the result: success, failure, cancelled
    # This prevents deployment when tests fail or checks don't pass
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    # Required permissions for this job
    # contents: read - read repository code
    # packages: write - push to GitHub Container Registry (ghcr.io)
    # id-token: write - needed for GCP authentication
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      # Step 1: Checkout code
      # Same as CI workflow - gets the code to build
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Login to GitHub Container Registry
      # Uses GITHUB_TOKEN (automatically provided by GitHub Actions)
      # No need for separate service account for container registry!
      # Much simpler than Artifact Registry setup
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}              # Your GitHub username
          password: ${{ secrets.GITHUB_TOKEN }}      # Auto-provided token

      # Step 3: Extract metadata for Docker image
      # docker/metadata-action generates tags and labels automatically
      # Tags generated:
      #   - ghcr.io/username/run-tbot:main (branch name)
      #   - ghcr.io/username/run-tbot:sha-abc123 (git commit)
      #   - ghcr.io/username/run-tbot:latest (always)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest

      # Step 4: Build and push Docker image
      # docker/build-push-action is more efficient than manual docker build + push
      # Uses Docker layer caching for faster builds
      # Automatically pushes all tags generated by metadata action
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-to: type=inline

      # Step 5: Authenticate to Google Cloud
      # Uses service account key from GitHub Secrets
      # This is needed for deploying to Cloud Run (not for pushing to ghcr.io!)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 6: Set up Cloud SDK
      # Install gcloud CLI for deployment commands
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Step 7: Deploy to Cloud Run
      # Uses image from GitHub Container Registry (ghcr.io)
      # Cloud Run pulls the image from public registry
      # Image format: ghcr.io/username/run-tbot:sha-abc123
      #
      # Key flags explained:
      #   --image: Docker image from GitHub Container Registry
      #   --platform managed: Use fully managed Cloud Run (not GKE)
      #   --region: Where to deploy (us-central1 recommended for free tier)
      #   --allow-unauthenticated: Allow public access (Telegram needs to reach webhook)
      #   --set-env-vars: Environment variables injected into container
      #   --port: Container listens on this port (matches main.go server port)
      #   --min-instances: Scale to zero when idle (FREE TIER optimization)
      #   --max-instances: Max 1 concurrent instance (FREE TIER limit)
      #   --memory: 256Mi RAM per instance (FREE TIER, sufficient for bot)
      #   --cpu: 1 vCPU (minimum, default)
      #   --timeout: 60s max request duration (sufficient for webhook)
      - name: Deploy to Cloud Run
        run: |
          # Get the SHA tag from metadata
          IMAGE_TAG="sha-${{ github.sha }}"
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

          echo "Deploying image: $IMAGE_URL"

          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image $IMAGE_URL \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars BOT_TOKEN=${{ secrets.BOT_TOKEN }},ENVIRONMENT=production,ALLOWED_USERS=${{ secrets.ALLOWED_USERS }} \
            --port 8080 \
            --min-instances 0 \
            --max-instances 1 \
            --memory 256Mi \
            --cpu 1 \
            --timeout 60s

      # Step 8: Get and display service URL
      # After deployment, retrieve the public HTTPS URL
      # Format: https://run-tbot-HASH-REGION.a.run.app
      # This URL is used for Telegram webhook registration
      - name: Get Service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ Deployment successful!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üåê Service URL: $SERVICE_URL"
          echo "üîó Webhook URL: $SERVICE_URL/webhook"
          echo ""
          echo "üìã To register webhook with Telegram:"
          echo ""
          echo "curl -X POST \"https://api.telegram.org/bot\$BOT_TOKEN/setWebhook\" \\"
          echo "  -H \"Content-Type: application/json\" \\"
          echo "  -d '{\"url\": \"$SERVICE_URL/webhook\"}'"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      # Step 9: Wait for service to be ready
      # Cloud Run deployment is async - service might not be immediately responsive
      # Poll health check endpoint until service responds
      # Timeout after 5 minutes (should be ready much faster)
      - name: Wait for service to be ready
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')

          echo "‚è≥ Waiting for service to be ready..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            # Try health check endpoint
            if curl -s -f -m 5 "$SERVICE_URL/" > /dev/null 2>&1; then
              echo "‚úÖ Service is ready and responding!"
              echo ""
              echo "üéâ Your bot is now deployed and ready to use!"
              echo ""
              echo "Next steps:"
              echo "1. Copy the curl command from above"
              echo "2. Replace \$BOT_TOKEN with your actual token"
              echo "3. Run the command to register webhook"
              echo "4. Test your bot in Telegram!"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "‚è≥ Attempt $attempt/$max_attempts - waiting 10s..."
            sleep 10
          done

          echo "‚ö†Ô∏è  Service didn't respond after 5 minutes"
          echo "Check Cloud Run logs for issues:"
          echo "https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}/logs"
          exit 1
